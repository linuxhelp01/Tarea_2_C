#include <16F877A.h>
#fuses HS,NOWDT,NOPUT,NOLVP,NOPROTECT,BROWNOUT
#use delay(clock=20M)

// Pines del MAX7219
#define MAX_DIN   PIN_B0
#define MAX_CLK   PIN_B1
#define MAX_CS    PIN_B2

// Pulso de reloj
void max_pulse_clk(void) {
   output_high(MAX_CLK);
   delay_us(1);
   output_low(MAX_CLK);
}

// Enviar 1 byte (MSB primero)
void max_sendByte(unsigned int8 data) {
   int i;
   for(i = 0; i < 8; i++) {
      if(data & 0x80)
         output_high(MAX_DIN);
      else
         output_low(MAX_DIN);

      max_pulse_clk();
      data <<= 1;
   }
}

// Enviar registro + dato
void max_send(unsigned int8 reg, unsigned int8 data) {
   output_low(MAX_CS);
   max_sendByte(reg);
   max_sendByte(data);
   output_high(MAX_CS);
}

void max_init(void) {
   // RB0, RB1, RB2 como salida
   set_tris_b(0b11111000);   // RB0-2 = 0 (salida), el resto entradas

   setup_adc_ports(NO_ANALOGS);
   setup_adc(ADC_OFF);

   output_low(MAX_DIN);
   output_low(MAX_CLK);
   output_high(MAX_CS);

   delay_ms(50);

   // Salir de shutdown
   max_send(0x0C, 0x01);   // SHUTDOWN register: normal operation
   // Scan limit: usar hasta el dígito 7 (todos, por si tu módulo trae 8 dígitos)
   max_send(0x0B, 0x07);
   // Intensidad media
   max_send(0x0A, 0x08);
}

void main(void) {
   max_init();

   while(TRUE) {
      // TEST ON: todos los segmentos de todos los dígitos encendidos
      max_send(0x0F, 0x01);   // DISPLAY TEST register: test mode on
      delay_ms(1000);

      // TEST OFF: vuelve a modo normal (pantalla en negro porque no hemos escrito nada)
      max_send(0x0F, 0x00);   // test mode off
      delay_ms(1000);
   }
}

