// --- CONSTANTES ---
#define CAUDAL        2.00  // m3/seg (Probando con caudal alto)
#define DELTA_MS      100   // Tiempo del ciclo main (0.1s)

// --- VARIABLES GLOBALES ---
int8  nivel = 0;           
int16 tiempo_seg = 0;      
int8  estado = 0;          

// --- VARIABLES INTERNAS (CORREGIDAS) ---
int32 ms_contador_nivel = 0; // Contador exclusivo para la física del agua
int32 ms_contador_reloj = 0; // Contador exclusivo para el segundero
int32 ms_velocidad = 0;      

// ---------------------------------------------------------
// CALCULAR FÍSICA
// ---------------------------------------------------------
void leer_forma_fisica() {
   float volumen = 0.0;
   
   // SWITCH E0 (0 = Cerrado/Prisma, 1 = Abierto/Cilindro)
   if (input(PIN_E0) == 0) {
      volumen = 12.0;       // PRISMA
   } else {
      volumen = 21.205;     // CILINDRO
   }

   float tiempo_total = volumen / CAUDAL;
   float tiempo_1_porc = tiempo_total / 100.0;
   
   ms_velocidad = (int32)(tiempo_1_porc * 1000.0);
}

// ---------------------------------------------------------
// LÓGICA PRINCIPAL CORREGIDA
// ---------------------------------------------------------
void gestionar_sistema() {
   
   // FASE 1: REPOSO
   if (estado == 0) {
      leer_forma_fisica();

      // Resetear contadores al iniciar
      ms_contador_nivel = 0;
      ms_contador_reloj = 0;

      if (input(PIN_E1) == 0 && nivel < 80) {
         estado = 1; 
      }
      else if (input(PIN_E2) == 0 && nivel >= 80) {
         estado = 2; 
      }
   }

   // FASE 2: MOVIMIENTO
   else {
      // Aumentamos AMBOS contadores por separado
      ms_contador_nivel += DELTA_MS;
      ms_contador_reloj += DELTA_MS;

      // --- LOGICA DEL RELOJ (Independiente) ---
      // Si pasaron 1000ms (1 segundo), sumamos tiempo y reseteamos SOLO este contador
      if (ms_contador_reloj >= 1000) {
         tiempo_seg++;
         ms_contador_reloj = 0; // Resetear solo el reloj
      }

      // --- LOGICA DEL NIVEL (Independiente) ---
      // Si pasó el tiempo necesario para subir 1%
      if (ms_contador_nivel >= ms_velocidad) {
         ms_contador_nivel = 0; // Resetear solo la física

         if (estado == 1) { // LLENANDO
            nivel++;
            if (nivel >= 80) { 
               nivel = 80; 
               estado = 0; 
            }
         }
         else if (estado == 2) { // VACIANDO
            nivel--;
            if (nivel <= 20) { 
               nivel = 20; 
               estado = 0; 
            }
         }
      }
   }
}
