// --- CONSTANTES PRE-CALCULADAS ---
// Basado en Caudal = 2.0
// Prisma (12m3) -> 6s total -> 1% en 60ms
// Cilindro (21.2m3) -> 10.6s total -> 1% en 106ms
#define VELOCIDAD_PRISMA   60
#define VELOCIDAD_CILINDRO 106
#define DELTA_MS           100   // Tiempo del bucle main

// --- VARIABLES GLOBALES ---
int8  nivel = 0;           // 0-100
int16 tiempo_seg = 0;      // Segundos transcurridos
int8  estado = 0;          // 0=Stop, 1=Llenando, 2=Vaciando

// --- VARIABLES INTERNAS ---
int16 ms_reloj = 0;        // Contador milisegundos para reloj
int16 ms_agua = 0;         // Contador milisegundos para nivel
int16 velocidad_actual = 60; 

void simular_estanque() {

   // ==========================================
   // CASO 1: SISTEMA DETENIDO (Configuración)
   // ==========================================
   if (estado == 0) {
      
      // 1. LEER FORMA (Solo permitimos cambiar si está quieto)
      // E0 en Pull-Up: 0 = Prisma, 1 = Cilindro
      if (input(PIN_E0) == 0) velocidad_actual = VELOCIDAD_PRISMA;
      else                    velocidad_actual = VELOCIDAD_CILINDRO;

      // 2. DETECTAR INICIO LLENADO (E1)
      if (input(PIN_E1) == 0 && nivel < 80) {
         estado = 1;
         // Resetear todo al iniciar
         tiempo_seg = 0; ms_reloj = 0; ms_agua = 0;
      }
      
      // 3. DETECTAR INICIO VACIADO (E2)
      else if (input(PIN_E2) == 0 && nivel >= 80) {
         estado = 2;
         // Resetear todo al iniciar
         tiempo_seg = 0; ms_reloj = 0; ms_agua = 0;
      }
   }

   // ==========================================
   // CASO 2: SISTEMA FUNCIONANDO (Simulación)
   // ==========================================
   else {
      ms_reloj += DELTA_MS;
      ms_agua  += DELTA_MS;

      // A. ACTUALIZAR RELOJ (1 segundo = 1000ms)
      if (ms_reloj >= 1000) {
         tiempo_seg++;
         ms_reloj = 0;
      }

      // B. ACTUALIZAR NIVEL AGUA
      if (ms_agua >= velocidad_actual) {
         ms_agua = 0;

         // Si estamos LLENANDO
         if (estado == 1) {
            nivel++;
            if (nivel >= 80) { // Meta
               nivel = 80; estado = 0; 
            }
         }
         // Si estamos VACIANDO
         else {
            nivel--;
            if (nivel <= 20) { // Meta
               nivel = 20; estado = 0; 
            }
         }
      }
   }
}
